data = {"media": "media/000000000006.jpg", "source": "val/PMC2724661_00000.jpg", "type": "image", "height": 792,
        "width": 612, "annotations": [
        {"bbox": [106.32, 175.44, 444.42, 107.26], "category": 4, "iscrowd": 0, "area": 44748.02314691106,
         "name": "PubLayNet Instance Segmentation", "source": "annotated", "ann_id": "3986627", "points": [
            [[106.32, 175.44], [550.74, 175.44], [550.74, 183.59], [550.52, 183.59], [550.52, 194.63], [548.01, 194.63],
             [548.01, 208.59], [550.64, 208.59], [550.64, 216.71], [547.92, 216.71], [547.92, 230.43], [550.49, 230.43],
             [550.49, 238.55], [550.47, 238.55], [550.47, 252.51], [550.7, 252.51], [550.7, 263.55], [550.74, 263.55],
             [550.74, 271.67], [293.88, 271.67], [293.88, 282.71], [106.32, 282.71], [106.32, 274.59], [106.32, 263.55],
             [106.32, 252.51], [106.32, 241.47], [106.32, 230.43], [106.32, 219.63], [106.32, 208.59], [106.32, 197.55],
             [106.32, 186.51], [106.32, 175.44]]], "order": 0},
        {"bbox": [63.84, 290.91, 515.43, 19.85], "category": 4, "iscrowd": 0, "area": 6317.983649535803,
         "name": "PubLayNet Instance Segmentation", "source": "annotated", "ann_id": "3986628", "points": [
            [[63.84, 290.91], [579.27, 290.91], [579.27, 300.51], [197.62, 300.51], [197.62, 310.76], [63.84, 310.76],
             [63.84, 300.51], [63.84, 300.51], [63.84, 290.91]]], "order": 1},
        {"bbox": [63.84, 347.84, 248.35, 129.96], "category": 4, "iscrowd": 0, "area": 30875.766545034945,
         "name": "PubLayNet Instance Segmentation", "source": "annotated", "ann_id": "3986629", "points": [
            [[63.84, 347.84], [312.02, 347.84], [312.02, 358.88], [312.1, 358.88], [312.1, 367.88], [312.03, 367.88],
             [312.03, 380.96], [312.12, 380.96], [312.12, 391.76], [312.16, 391.76], [312.16, 400.76], [312.06, 400.76],
             [312.06, 411.8], [312.02, 411.8], [312.02, 422.84], [309.5, 422.84], [309.5, 435.93], [312.19, 435.93],
             [312.19, 444.92], [312.08, 444.92], [312.08, 457.77], [312.1, 457.77], [312.1, 466.76], [189.62, 466.76],
             [189.62, 477.8], [63.84, 477.8], [63.84, 468.81], [63.84, 457.77], [63.84, 446.97], [63.84, 435.93],
             [63.84, 424.89], [63.84, 413.85], [63.84, 402.8], [63.84, 391.76], [63.84, 380.96], [63.84, 369.92],
             [63.84, 358.88], [63.84, 347.84]]], "order": 2},
        {"bbox": [330.96, 330.8, 248.28, 229.07], "category": 4, "iscrowd": 0, "area": 55161.65754630137,
         "name": "PubLayNet Instance Segmentation", "source": "annotated", "ann_id": "3986630", "points": [
            [[330.96, 330.8], [579.24, 330.8], [579.24, 339.8], [579.19, 339.8], [579.19, 350.83], [579.18, 350.83],
             [579.18, 362.43], [576.66, 362.43], [576.66, 374.87], [576.75, 374.87], [576.75, 384.51], [576.66, 384.51],
             [576.66, 396.74], [576.67, 396.74], [576.67, 407.84], [579.19, 407.84], [579.19, 418.88], [579.21, 418.88],
             [579.21, 427.88], [576.62, 427.88], [576.62, 440.96], [576.67, 440.96], [576.67, 451.76], [579.2, 451.76],
             [579.2, 460.75], [576.62, 460.75], [576.62, 473.84], [579.24, 473.84], [579.24, 482.83], [579.17, 482.83],
             [579.17, 493.87], [576.66, 493.87], [576.66, 506.96], [579.18, 506.96], [579.18, 517.76], [579.19, 517.76],
             [579.19, 528.8], [579.24, 528.8], [579.24, 537.79], [579.19, 537.79], [579.19, 548.83], [446.93, 548.83],
             [446.93, 559.87], [330.96, 559.87], [330.96, 550.88], [330.96, 539.84], [330.96, 528.8], [330.96, 517.76],
             [330.96, 506.96], [330.96, 495.92], [330.96, 484.88], [330.96, 473.84], [330.96, 462.8], [330.96, 451.76],
             [330.96, 440.96], [330.96, 429.92], [330.96, 418.88], [330.96, 406.35], [330.96, 406.35], [330.96, 396.74],
             [330.96, 385.76], [330.96, 373.47], [330.96, 373.47], [330.96, 363.85], [330.96, 352.81], [330.96, 341.84],
             [330.96, 330.8]]], "order": 3},
        {"bbox": [63.84, 485.85, 250.67, 174.12], "category": 4, "iscrowd": 0, "area": 43056.88136011828,
         "name": "PubLayNet Instance Segmentation", "source": "annotated", "ann_id": "3986631", "points": [
            [[63.84, 485.85], [312.07, 485.85], [312.07, 494.84], [309.52, 494.84], [309.52, 507.93], [309.54, 507.93],
             [309.54, 518.97], [309.55, 518.97], [309.55, 529.77], [312.06, 529.77], [312.06, 538.76], [309.53, 538.76],
             [309.53, 551.85], [312.1, 551.85], [312.1, 560.84], [309.54, 560.84], [309.54, 573.83], [312.06, 573.83],
             [312.06, 583.47], [312.04, 583.47], [312.04, 595.77], [312.08, 595.77], [312.08, 604.76], [312.07, 604.76],
             [312.07, 616.35], [309.52, 616.35], [309.52, 628.89], [312.2, 628.89], [312.2, 637.88], [312.04, 637.88],
             [312.04, 650.97], [314.51, 650.97], [314.51, 659.97], [63.84, 659.97], [63.84, 649.48], [63.84, 649.48],
             [63.84, 639.86], [63.84, 627.4], [63.84, 627.4], [63.84, 616.35], [63.84, 616.35], [63.84, 606.72],
             [63.84, 595.77], [63.84, 583.47], [63.84, 583.47], [63.84, 573.83], [63.84, 562.89], [63.84, 551.85],
             [63.84, 540.81], [63.84, 529.77], [63.84, 518.97], [63.84, 507.93], [63.84, 496.89], [63.84, 485.85]]],
         "order": 4}, {"bbox": [330.96, 567.92, 248.3, 30.84], "category": 4, "iscrowd": 0, "area": 7002.578919222578,
                       "name": "PubLayNet Instance Segmentation", "source": "annotated", "ann_id": "3986632",
                       "points": [
                           [[330.96, 567.92], [579.21, 567.92], [579.21, 578.96], [579.26, 578.96], [579.26, 587.95],
                            [518.77, 587.95], [518.77, 598.75], [330.96, 598.75], [330.96, 589.76], [330.96, 578.96],
                            [330.96, 567.92]]], "order": 5},
        {"bbox": [330.96, 623.84, 248.26, 97.08], "category": 4, "iscrowd": 0, "area": 23974.417036587372,
         "name": "PubLayNet Instance Segmentation", "source": "annotated", "ann_id": "3986633", "points": [
            [[330.96, 623.84], [579.12, 623.84], [579.12, 632.83], [576.66, 632.83], [576.66, 645.92], [579.14, 645.92],
             [579.14, 656.96], [579.19, 656.96], [579.19, 665.96], [576.66, 665.96], [576.66, 676.76], [576.65, 676.76],
             [576.65, 689.84], [579.22, 689.84], [579.22, 698.84], [579.17, 698.84], [579.17, 709.88], [576.68, 709.88],
             [576.68, 720.92], [330.96, 720.92], [330.96, 711.92], [330.96, 700.88], [330.96, 689.84], [330.96, 678.8],
             [330.96, 667.76], [330.96, 656.96], [330.96, 645.92], [330.96, 634.88], [330.96, 623.84]]], "order": 6},
        {"bbox": [63.84, 680.62, 247.71, 34.36], "category": 4, "iscrowd": 0, "area": 6449.615115458262,
         "name": "PubLayNet Instance Segmentation", "source": "annotated", "ann_id": "3986634", "points": [
            [[63.84, 680.62], [309.63, 680.62], [309.63, 689.74], [311.55, 689.74], [311.55, 696.98], [227.13, 696.98],
             [227.13, 706.1], [168.08, 706.1], [168.08, 714.98], [63.84, 714.98], [63.84, 707.74], [63.84, 698.86],
             [63.84, 689.74], [63.84, 680.62]]], "order": 7},
        {"bbox": [63.84, 136.15, 487.14, 24.61], "category": 4, "iscrowd": 0, "area": 7114.2102084743965,
         "name": "PubLayNet Instance Segmentation", "source": "annotated", "ann_id": "3986635", "points": [
            [[63.84, 136.15], [550.98, 136.15], [550.98, 149.24], [127.98, 149.24], [127.98, 160.76], [63.84, 160.76],
             [63.84, 147.67], [63.84, 136.15]]], "order": 8},
        {"bbox": [63.84, 103.13, 438.36, 11.29], "category": 4, "iscrowd": 0, "area": 4946.916783336565,
         "name": "PubLayNet Instance Segmentation", "source": "annotated", "ann_id": "3986636",
         "points": [[[63.84, 103.13], [502.2, 103.13], [502.2, 114.42], [63.84, 114.42], [63.84, 103.13]]], "order": 9},
        {"bbox": [63.84, 60.49, 521.0, 30.75], "category": 5, "iscrowd": 0, "area": 8295.164085415956,
         "name": "PubLayNet Instance Segmentation", "source": "annotated", "ann_id": "3986637", "points": [
            [[63.84, 60.49], [584.84, 60.49], [584.84, 74.69], [118.23, 74.69], [118.23, 91.25], [63.84, 91.25],
             [63.84, 77.05], [63.84, 60.49]]], "order": 10},
        {"bbox": [63.84, 330.98, 82.12, 8.82], "category": 5, "iscrowd": 0, "area": 724.0633860095986,
         "name": "PubLayNet Instance Segmentation", "source": "annotated", "ann_id": "3986638",
         "points": [[[63.84, 330.98], [145.96, 330.98], [145.96, 339.8], [63.84, 339.8], [63.84, 330.98]]],
         "order": 11}, {"bbox": [330.96, 606.98, 143.3, 8.82], "category": 5, "iscrowd": 0, "area": 1263.4498333899537,
                        "name": "PubLayNet Instance Segmentation", "source": "annotated", "ann_id": 3986639,
                        "points": [
                            [[330.96, 606.98], [474.26, 606.98], [474.26, 615.79], [330.96, 615.79], [330.96, 606.98]]],
                        "order": 12}]}

from dsdl.geometry import ClassDomain
from dsdl.fields import *

ClassDomain(
    name="PubLayNetClassDom",
    classes=["figure", "list", "table", "text", "title"],
)


class LocalObjectEntry(Struct):
    __params__ = ["cdom"]
    __fields__ = {
        "bbox": BBox(),
        "category": Label(dom="$cdom"),
        "iscrowd": Int(),
        "area": Num(),
        "name": Str(),
        "source": Str(),
        "ann_id": Str(),
        "points": Polygon(),
        "order": Int(),
        "corrected": Bool(),
        "modified": Bool()
    }
    __optional__ = ["area", "modified", "iscrowd", "corrected"]


class ObjectDetectionSample(Struct):
    __params__ = ["cdom"]
    __fields__ = {
        "media": Image(),
        "source": Str(),
        "type": Str(),
        "height": Int(),
        "width": Int(),
        "annotations": List(etype=LocalObjectEntry(cdom="$cdom"))
    }


## generate instance
from dsdl.objectio import AliOSSFileReader

ali_oss_cfg = dict(
    access_key_secret="VjXlqXibBKn3Va5FqoykTpWDInu88n",
    endpoint="http://oss-cn-shanghai.aliyuncs.com",
    access_key_id="LTAI5t98SK62yB6x1dSFeR5v",
    bucket_name="odl-standard",
    working_dir="PubLayNet/standard/0.3/")
reader = AliOSSFileReader(**ali_oss_cfg)

sample_type = ObjectDetectionSample(cdom="PubLayNetClassDom")
sample_type.set_file_reader(reader)
# sample_type.set_lazy_init(True)
sample = sample_type(data)

### test

print(sample_type._FLATTEN_STRUCT)
print(sample.annotations[0].points)
# print(sample.extract_field_info(["image"]))
print(sample.extract_path_info("./*/*/bbox", verbose=True))
#
# ### visualize  ####
#
# from dataset.utils import ImageVisualizePipeline
#
# vis_obj = ImageVisualizePipeline(["image", "label", "bbox", "keypoint", "polygon"], sample)
# vis_res = vis_obj.visualize()
# print(vis_res)
# vis_res["./media"].save("./test.png")


